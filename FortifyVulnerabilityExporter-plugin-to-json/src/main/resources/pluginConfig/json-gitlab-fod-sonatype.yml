---
spring.config.activate.on-loader-plugin: fod

json.gitlab.sonatype.filter.expr: vuln.scantype=='Open Source'
json.gitlab.sonatype.format:
  fields:
    schema: https://gitlab.com/gitlab-org/security-products/security-report-schemas/-/raw/master/dist/dependency-scanning-report-format.json
    version: 12.1.0
    scan:
      # TODO static* -> ???
      start_time: $[#formatDateTime("yyyy-MM-dd'T'HH:mm:ss", release.openSourceScanSummary?.startedDateTime?:'1970-01-01T00:00:00')]
      end_time: $[#formatDateTime("yyyy-MM-dd'T'HH:mm:ss", release.openSourceScanSummary?.completedDateTime?:'1970-01-01T00:00:00')]
      status: success # TODO: $[release.openSourceAnalysisStatusTypeId==2?'success':'failure']
      type: dependency_scanning
      scanner:
        id: FoD-sonatype
        name: Fortify on Demand/Sonatype
        url: https://www.microfocus.com/en-us/products/application-security-testing/overview
        version: TODO
        vendor: 
          name: Fortify+Sonatype
    dependency_files: $[{}]
    vulnerabilities: $[vulnerabilityMappers.vulnerability.get()]
  vulnerabilityMappers.vulnerability.fields:
    id: $[vuln.vulnId]
    category: dependency_scanning
    name: $[vuln.category]
    message: $[vuln.category]
    description: $[#htmlToText(vuln.details?.summary)]
    cve: N/A
    severity: $[vuln.severityString]
    confidence: $[(vuln.severityString matches "(Critical|Medium)") ? "High":"Low" ]
    scanner:
      id: FoD-sonatype
      name: Fortify on Demand/Sonaytype
    identifiers: |-
      $[
        #merge(
          {
            {
              name:  "Instance id: "+vuln.instanceId,
              url:   vuln.deepLink,
              type:  "issueInstanceId",
              value: vuln.instanceId
            }
          },
          vuln.complianceItems.![{
            name: categoryName+': '+complianceRule,
            type: categoryName.replaceAll("\s+","").toLowerCase(),
            value: complianceRule 
          }]
        )
      ]
    links:
      - name: Additional issue details, including analysis trace, in Fortify on Demand
        url:  $[vuln.deepLink]
    location:
      file:           $[vuln.primaryLocationFull]
      dependency:
        package.name: $[#substringBefore(vuln.primaryLocationFull, '@')] # TODO needs to be improved
        version:      $[#substringAfter(vuln.primaryLocationFull, '@')] # TODO needs to be improved
        
        
    
    
    
    
    