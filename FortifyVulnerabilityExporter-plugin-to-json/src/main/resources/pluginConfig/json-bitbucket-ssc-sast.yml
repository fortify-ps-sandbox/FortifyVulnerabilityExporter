---
spring.config.activate.on-loader-plugin: ssc

#json.bitbucket.sast.report.filter.expr: # Not needed as we don't process any vulnerabilities for the top-level report
json.bitbucket.sast.report.format:
  fields:
    # uuid:
    title: Fortify Scan Report
    details: Fortify detected $[vulnerabilityMappers.friority.get().size()] $[vulnerabilityMappers.friority.get().size()==1 ? 'vulnerability':'vulnerabilities']
    #external_id:
    reporter: Fortify Static Code Analyzer $[applicationVersion.currentStaticScan?.engineVersion?:'']
    link: $[applicationVersion.deepLink]
    # remote_link_enabled:
    logo_url: https://bitbucket.org/workspaces/fortifysoftware/avatar
    report_type: SECURITY
    result: 'PASSED'
    data:
      - type: TEXT
        title: Application Version
        value: $[applicationVersion.project.name] - $[applicationVersion.name]
      - type: DATE
        title: Last Static Scan
        value: $[#formatDateTime("yyyy-MM-dd'T'HH:mm:ss.SSSSSS'Z'", applicationVersion.currentStaticScan?.uploadDate?:'1970-01-01T00:00:00')]
      - type: NUMBER
        title: Critical (SAST)
        value: $[applicationVersion.issueCountsSCA.^[id=='Critical']?.visibleCount?:0]
      - type: NUMBER
        title: Critical (Overall)
        value: $[applicationVersion.issueCounts.^[id=='Critical']?.visibleCount?:0]
      - type: NUMBER
        title: High (SAST)
        value: $[applicationVersion.issueCountsSCA.^[id=='High']?.visibleCount?:0]
      - type: NUMBER
        title: High (Overall)
        value: $[applicationVersion.issueCounts.^[id=='High']?.visibleCount?:0]
      - type: NUMBER
        title: Medium (SAST)
        value: $[applicationVersion.issueCountsSCA.^[id=='Medium']?.visibleCount?:0]
      - type: NUMBER
        title: Medium (Overall)
        value: $[applicationVersion.issueCounts.^[id=='Medium']?.visibleCount?:0]
      - type: NUMBER
        title: Low (SAST)
        value: $[applicationVersion.issueCountsSCA.^[id=='Low']?.visibleCount?:0]
      - type: NUMBER
        title: Low (Overall)
        value: $[applicationVersion.issueCounts.^[id=='Low']?.visibleCount?:0]
  vulnerabilityMappers:
    friority.value: $[vuln.friority] 

json.bitbucket.sast.annotations.filter.expr: vuln.engineType=='SCA'
json.bitbucket.sast.annotations.format: 
  vulnerabilityMappers:
    annotations.fields:
      external_id: FTFY-$[vuln.id]
      # uuid:
      annotation_type: VULNERABILITY
      path: $[vuln.fullFileName]
      line: $[vuln.lineNumber==0?1:vuln.lineNumber]
      summary: $[vuln.issueName]
      details: $[vuln.details?.brief]
      # result: PASSED|FAILED|SKIPPED|IGNORED
      severity: $[vuln.friority.toUpperCase()] 
      link: $[vuln.deepLink]
      # created_on:
      # updated_on: