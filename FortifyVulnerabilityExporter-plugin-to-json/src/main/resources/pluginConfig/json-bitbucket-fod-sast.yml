---
spring.config.activate.on-loader-plugin: fod

#json.bitbucket.sast.report.filter.expr: # Not needed as we don't process any vulnerabilities for the top-level report
json.bitbucket.sast.report.format:
  fields:
    # uuid:
    title: Fortify Scan Report
    details: Fortify on Demand detected $[release.issueCount] $[release.issueCount==1 ? 'vulnerability':'vulnerabilities']
    #external_id:
    reporter: Fortify on Demand
    link: $[release.deepLink]
    # remote_link_enabled:
    logo_url: https://bitbucket.org/workspaces/fortifysoftware/avatar
    report_type: SECURITY
    result: $[release.isPassed ? 'PASSED':'FAILED']
    data:
      - type: DATE
        title: Static Scan Date # Apparently BB is very strict on how TZ is presented, so we always provide UTC date/time
        value: $[#formatDateTimewithZoneIdAsUTC("yyyy-MM-dd'T'HH:mm:ss.SSSSSS'Z'", release.staticScanDate?:'1970-01-01T00:00:00', release.serverZoneId)]
      - type: NUMBER
        title: Rating
        value: $[release.rating]
      - type: NUMBER
        title: Critical (SAST)
        value: $[release.staticCritical]
      - type: NUMBER
        title: Critical (Overall)
        value: $[release.critical]
      - type: NUMBER
        title: High (SAST)
        value: $[release.staticHigh]
      - type: NUMBER
        title: High (Overall)
        value: $[release.high]
      - type: NUMBER
        title: Medium (SAST)
        value: $[release.staticMedium]
      - type: NUMBER
        title: Medium (Overall)
        value: $[release.medium]
      - type: NUMBER
        title: Low (SAST)
        value: $[release.staticLow]
      - type: NUMBER
        title: Low (Overall)
        value: $[release.low]

json.bitbucket.sast.annotations.filter.expr: vuln.scantype=='Static'
json.bitbucket.sast.annotations.format: 
  vulnerabilityMappers:
    annotations.fields:
      external_id: FTFY-$[vuln.id]
      # uuid:
      annotation_type: VULNERABILITY
      path: $[vuln.primaryLocationFull]
      line: $[vuln.lineNumber==0?1:vuln.lineNumber]
      summary: $[vuln.category]
      details: $[#htmlToText(vuln.details?.summary)]
      # result: PASSED|FAILED|SKIPPED|IGNORED
      severity: $[(vuln.severityString matches "(Critical|High|Medium|Low)") ? vuln.severityString.toUpperCase():"LOW"] 
      link: $[vuln.deepLink]
      # created_on:
      # updated_on: